<!DOCTYPE html>
<html>
<head>
    <title>Detailed Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f4f9; padding: 30px; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        .grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        
        h2 { margin-top: 0; color: #444; font-size: 18px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        th, td { padding: 15px; text-align: center; border-bottom: 1px solid #eee; }
        th { background-color: #007bff; color: white; font-size: 14px; }
        td { font-size: 14px; color: #333; }
        tr:hover { background-color: #f8f9fa; }
        
        /* Specific column colors for clarity */
        .col-phone { color: #e91e63; font-weight: bold; }
        .col-sleep { color: #9c27b0; font-weight: bold; }
        .col-look { color: #ff9800; font-weight: bold; }

        .btn { background: #333; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block; margin-bottom: 20px; transition: 0.2s; }
        .btn:hover { background: #000; }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="btn">‚Üê Back to Login</a>
        <h1>Student Performance Report</h1>

        <div class="grid">
            <div class="card">
                <h2>Focus Score Trend</h2>
                <canvas id="trendChart"></canvas>
            </div>
            <div class="card">
                <h2>Global Distraction Analysis</h2>
                <canvas id="breakdownChart"></canvas>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th style="text-align: left;">Name</th>
                    <th>Date</th>
                    <th>Score</th>
                    <th>Total Time Distracted(in sec)</th> 
                    <th style="background:#e91e63;">üì± Phone</th>
                    <th style="background:#9c27b0;">üò¥ Sleep</th>
                    <th style="background:#ff9800;">üëÄ Look Away</th>
                </tr>
            </thead>
            <tbody>
                {% for row in sessions %}
                <tr>
                    <td>{{ row.id }}</td>
                    <td style="text-align: left;"><b>{{ row.name }}</b></td>
                    <td>{{ row.date }}</td>
                    
                    <td style="color: {{ 'green' if row.score >= 80 else 'red' }}">
                        <b>{{ row.score }}%</b>
                    </td>
                    
                    <td>{{ row.total }}</td>
                    
                    <td class="col-phone">{{ row.phone }}</td>
                    <td class="col-sleep">{{ row.sleep }}</td>
                    <td class="col-look">{{ row.look_away }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        const dates = {{ dates | safe }};
        const scores = {{ scores | safe }};
        const breakdown = {{ breakdown | safe }};

        // --- FIX: SPLIT DATA FOR PROPER LEGEND ---
        // Create two separate arrays. If a score doesn't fit the category, use null (so no bar is drawn).
        const highFocusData = scores.map(s => s >= 80 ? s : null);
        const lowFocusData = scores.map(s => s < 80 ? s : null);

        if (dates.length > 0) {
            new Chart(document.getElementById('trendChart'), {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'High Focus (>80%)',
                            data: highFocusData,
                            backgroundColor: '#28a745',
                            borderRadius: 5,
                            stack: 'combined'  // Stacking ensures bars stay centered
                        },
                        {
                            label: 'Needs Improvement (<80%)',
                            data: lowFocusData,
                            backgroundColor: '#dc3545',
                            borderRadius: 5,
                            stack: 'combined'
                        }
                    ]
                },
                options: { 
                    responsive: true, 
                    scales: { 
                        y: { beginAtZero: true, max: 100 },
                        x: { stacked: true } // Enable stacking on X-axis
                    } 
                }
            });
        }

        // Updated Total Calculation
        const total = breakdown.phone + breakdown.sleep + breakdown.look_away;
        
        if (total > 0) {
            new Chart(document.getElementById('breakdownChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Phone', 'Sleep', 'Look Away'],
                    datasets: [{
                        data: [breakdown.phone, breakdown.sleep, breakdown.look_away],
                        backgroundColor: ['#e91e63', '#9c27b0', '#ff9800']
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });
        } else {
            const ctx = document.getElementById('breakdownChart').getContext('2d');
            ctx.font = "16px Arial";
            ctx.textAlign = "center";
            ctx.fillText("No Distractions Recorded", 150, 75);
        }
    </script>
</body>
</html>